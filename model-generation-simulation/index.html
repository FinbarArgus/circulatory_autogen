
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://finbarargus.github.io/circulatory_autogen/model-generation-simulation/">
      
      
        <link rel="prev" href="../getting-started/">
      
      
        <link rel="next" href="../design-model/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Model Generation and Simulation - Circulatory Autogen</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#model-generation-and-simulation" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Circulatory Autogen" class="md-header__button md-logo" aria-label="Circulatory Autogen" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Circulatory Autogen
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Model Generation and Simulation
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Circulatory Autogen" class="md-nav__button md-logo" aria-label="Circulatory Autogen" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Circulatory Autogen
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome to Circulatory Autogen
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Model Generation and Simulation
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Model Generation and Simulation
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#software-outline" class="md-nav__link">
    <span class="md-ellipsis">
      Software Outline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model-generation" class="md-nav__link">
    <span class="md-ellipsis">
      Model Generation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model-simulation" class="md-nav__link">
    <span class="md-ellipsis">
      Model Simulation
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../design-model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Designing a model
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../parameter-identification/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Parameter Identification
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../example-3compartment-model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Example: 3Compartment Model
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../running-on-hpc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Running on the HPC
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#software-outline" class="md-nav__link">
    <span class="md-ellipsis">
      Software Outline
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model-generation" class="md-nav__link">
    <span class="md-ellipsis">
      Model Generation
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#model-simulation" class="md-nav__link">
    <span class="md-ellipsis">
      Model Simulation
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="model-generation-and-simulation">Model Generation and Simulation</h1>
<h2 id="software-outline">Software Outline</h2>
<p>The Circulatory_Autogen project (<code>[project_dir]</code>) contains five folders as presented below:       </p>
<ul>
<li><strong>resources</strong>: Contains example config csv files that define models (<code>[file_prefix]_vessel_array.csv</code>), parameters (<code>[file_prefix]_parameters.csv</code>), parameters to calibrate (<code>[file_prefix]_params_for_id.csv</code>), and ground truth data to calibrate towards (<code>[file_prefix]_obs_data.json</code>) for generating and calibrating models.</li>
<li><strong>src</strong>: Containts the source code for autogeneration, parameter id, and other utilities.</li>
<li><strong>user_run_files</strong>: Includes bash run files for the user and the <code>user_inputs.yaml</code> file, which is the main config file for the run settings.</li>
<li><strong>funcs_user</strong>: Contains user defined functions for calculating ouput features from model outputs, for fitting to ground truths. The corresponding src file, which contains other available functions to use in the parameter id is <code>[project_dir]/src/param_id/operation_funcs.py</code>. This directory also contains functions for user defined cost functions.</li>
<li><strong>module_config_user</strong>: Contains user defined units, cellml modules, and configuration files for those cellml modules. This allows the user to create their own modules and specify how they can be coupled with other modules. The corresponding src dir, which contains all of the src modules and config files is <code>[project_dir]/src/generators/resources/</code>  </li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>For recommended use, the user should create a separate [CA_user_dir] for the specific model they are creating. In dir there should be the following:</p>
<ul>
<li>**[file_prefix]_user_inputs.yaml</li>
<li><strong>resources</strong>: Contains the config csv files that defines model connection network ([file_prefix]_vessel_array.csv) and parameters ([file_prefix]_parameters.csv) that will be generated and config files to prescribe the parameters to calibrate ([file_prefix]_params_for_id.csv) and the ground truth to calibrate towards ([file_prefix]_obs_data.json).</li>
</ul>
</div>
<p>The following folders will be generated in <code>[CA_user_dir]</code> (or <code>[project_dir]</code> if <code>user_inputs_path_override</code> isn't defined) after running model autogeneration and parameter identification.</p>
<ul>
<li><strong>generated_models</strong>: Includes the generated code for the models that have been automatically generated. It also contains the generated models with parameters that have been fit with the parameter identification code. These models can be run in OpenCOR or through OpenCOR's version of Python.</li>
<li><strong>param_id_output</strong>: Includes all of the outputs from the parameter identification simulations, including predicted parameter values, minimum costs, standard deviations of parameters (if doing MCMC) and plots of the fitting results and parameter distributions.</li>
</ul>
<h2 id="model-generation">Model Generation</h2>
<p>This section shows how to generate your desired model. There are several examples to show the generality of the circulatory_autogen software.</p>
<p>The following are the steps for model autogeneration.</p>
<ol>
<li>
<p>Create the <strong>vessel_array</strong> and <strong>parameters</strong> files in CSV format for the intended model. Standard names of vessel and parameters files are <strong>[model name]_vessel_array.csv</strong> and <strong>[model name]_parameters.csv</strong>, respectively. </p>
<p>Those files should be added to your <code>resources</code> directory which is set with <code>resources_dir</code> in your <code>[CA_user_dir]/[file_prefix]_user_inputs.yaml</code> (or <code>[project_dir]/user_run_files/user_inputs.yaml</code> if <code>user_inputs_path_override</code> isn't defined). </p>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>The standard location for the resources dir is `[CA_user_dir]/resources</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>If the name of your model is <em>3compartment</em>, the user files needed for generation are:</p>
<ul>
<li><code>3compartment_vessel_array.csv</code></li>
<li><code>3compartment_parameters.csv</code></li>
</ul>
</div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>You can refer to the section <a href="../design-model/">Designing a new model</a> for more details on creating vessel_array and parameters files.</p>
</div>
<ol>
<li>
<p>Go to the <code>[CA_user_dir]</code> and open the <code>[file_prefix]_user_inputs.yaml</code> to edit. You can use <em>gedit</em>, <em>nano</em>, <em>vim</em> or your editor of choice to edit the file. <code>file_prefix</code> should be the name of your model. Subsequently, <code>input_param_file</code> should be equal to <code>[file_prefix]_parameters.csv</code> as shown below.</p>
<p><img alt="user_inputs.yaml file" src="../images/user-inputs.png" /></p>
</li>
<li>
<p>To run the autogeneration, navigate to the <code>user_run_files</code> directory and run the below command.</p>
<pre><code>./run_autogeneration.sh
</code></pre>
<p>As shown below, this will create CellML files for the generated model and test that the simulation runs. Consequently, If there are no errors, it shows the <em>"Model generation has been successful."</em> message at the end.</p>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>Alternatively, you can use an IDE of your choice, set the python path equal to the <code>opencor_pythonshell_path</code> (see <a href="../getting-started/">getting started</a> and 
run script_generate_with_new_architecture.py from <code>[project_dir]/src/scripts</code></p>
<p><img alt="Run autogeneration output" src="../images/run-autogeneration.png" /></p>
</div>
<ol>
<li>
<p>Generated CellML files are located in the <code>[generated_models_dir]/[file_prefix]</code> directory. (The <em>generated_models_dir</em> defaults to <code>[project_dir]/generated_models</code> unless you set generated_models_dir in <code>[project_dir/user_run_files/user_inputs.yaml</code>). </p>
<p>Four CellML files, and a CSV file will be generated. The CSV file includes the model parameters and the four CellML files contain the modules, parameters, units and constants, and main model.</p>
<p><img alt="Generated files" src="../images/generated-files.png" /></p>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>For a typical autogeneration, the parameters.csv file will be the same as the parameters.csv file in <code>[project_dir]/resources</code> directory. However, when the parameter identification is run, it will contain the identified parameter values.</p>
</div>
</li>
</ol>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>There is a test for the autogeneration running. To run the test, navigate to <code>user_run_files</code> and run the below command.</p>
<pre><code>./run_test_autogeneration.sh
</code></pre>
</div>
<h2 id="model-simulation">Model Simulation</h2>
<p>Once you have generated the models, open OpenCOR and open the generated <code>[file_prefix].cellml</code>, which is the main CellML file. This file automatically incorporates the <code>[file_prefix]_modules.cellml</code>, <code>[file_prefix]_parameters.cellml</code> and <code>[file_prefix]_units.cellml</code> files.</p>
<p>When it is opened, click on the <strong>Simulation</strong> tab (highlighted with a yellow box in the below image). If there is no error, OpenCOR shows you a new page where models can be simulated. (If there is an error specific to the cellml code then it will be shown here.)</p>
<p><img alt="Model Simulation" src="../images/model-simulation.png" /></p>
<p>Several individual parts on this page are:</p>
<ul>
<li>Simulation settings</li>
<li>ODE solver settings</li>
<li>Parameters and variables</li>
<li>Run control</li>
<li>Run diagnostics</li>
<li>Graphs and results</li>
</ul>
<p>You should set the simulation's starting, ending, and data output step size. Also, if you have a stiff problem you may need to set the maximum_time_step to a small value.</p>
<p>ODE solver settings contains many settings related to the solver such as maximum step size, iteration method, absolute and relative tolerance, name of solver, etc. (shown in the blue box in the above image.)</p>
<p>The parameters and variables section shows all constant and variable parameters that are used in the model (See section <a href="create-model.md">Creating a new model</a> for more information on setting up parameters). You can plot variables by right-clicking each parameter you want for the y-axis and then choosing the x-axis variable (eg: time). </p>
<p>The run control is on the top left section, as shown in the purple color box in the image. Click on the triangle button to run. For further control, see the <a href="https://tutorial-on-cellml-opencor-and-pmr.readthedocs.io/en/latest/_downloads/d271cfcef7e288704c61320e64d77e2d/OpenCOR-Tutorial-v17.pdf">OpenCOR Tutorial</a>.</p>
<p>The results will be shown after running the model. These results include run-time, settings, and other related parameters, as shown in the yellow box at the bottom of the image.</p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["instant", "content.code.copy"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>