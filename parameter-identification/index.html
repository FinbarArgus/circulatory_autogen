
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://finbarargus.github.io/circulatory_autogen/parameter-identification/">
      
      
        <link rel="prev" href="../design-model/">
      
      
        <link rel="next" href="../example-3compartment-model/">
      
      
      <link rel="icon" href="../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.1, mkdocs-material-9.6.14">
    
    
      
        <title>Parameter Identification - Circulatory Autogen</title>
      
    
    
      <link rel="stylesheet" href="../assets/stylesheets/main.342714a4.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
    <script>__md_scope=new URL("..",location),__md_hash=e=>[...e].reduce(((e,_)=>(e<<5)-e+_.charCodeAt(0)),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#parameter-identification" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href=".." title="Circulatory Autogen" class="md-header__button md-logo" aria-label="Circulatory Autogen" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3zm0 5h18v2H3zm0 5h18v2H3z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            Circulatory Autogen
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              Parameter Identification
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var palette=__md_get("__palette");if(palette&&palette.color){if("(prefers-color-scheme)"===palette.color.media){var media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']");palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent")}for(var[key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      
      
        <label class="md-header__button md-icon" for="__search">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        </label>
        <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.52 6.52 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
      
    
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href=".." title="Circulatory Autogen" class="md-nav__button md-logo" aria-label="Circulatory Autogen" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54"/></svg>

    </a>
    Circulatory Autogen
  </label>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href=".." class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Welcome to Circulatory Autogen
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../getting-started/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Getting Started
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../model-generation-simulation/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Model Generation and Simulation
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../design-model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Designing a model
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
    
  
  
  
    <li class="md-nav__item md-nav__item--active">
      
      <input class="md-nav__toggle md-toggle" type="checkbox" id="__toc">
      
      
        
      
      
        <label class="md-nav__link md-nav__link--active" for="__toc">
          
  
  
  <span class="md-ellipsis">
    Parameter Identification
    
  </span>
  

          <span class="md-nav__icon md-icon"></span>
        </label>
      
      <a href="./" class="md-nav__link md-nav__link--active">
        
  
  
  <span class="md-ellipsis">
    Parameter Identification
    
  </span>
  

      </a>
      
        

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#creating-params_for_id-file" class="md-nav__link">
    <span class="md-ellipsis">
      Creating params_for_id file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-param-id-observables-file" class="md-nav__link">
    <span class="md-ellipsis">
      Creating param id observables file
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
      
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../example-3compartment-model/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Example: 3Compartment Model
    
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../running-on-hpc/" class="md-nav__link">
        
  
  
  <span class="md-ellipsis">
    Running on the HPC
    
  </span>
  

      </a>
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#creating-params_for_id-file" class="md-nav__link">
    <span class="md-ellipsis">
      Creating params_for_id file
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#creating-param-id-observables-file" class="md-nav__link">
    <span class="md-ellipsis">
      Creating param id observables file
    </span>
  </a>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  



<h1 id="parameter-identification">Parameter Identification</h1>
<p>The parameter identification part of Circulatory_Autogen is designed to allow calibration of a model to experimental or clinical data. It implements an optimisation method to find the best fit parameters that give a minimal (local minima) error difference between the model output and the ground truth observables (experimental or clinical data or user specified). The creation of below two configuration files is necessary: </p>
<ul>
<li><strong>params_for_id</strong></li>
<li><strong>param id observables</strong></li>
</ul>
<p>Those files should be added to the <code>[CA_dir]/resources</code> directory. Proper names of the files are <strong>[file_prefix]_params_for_id.csv</strong> and <strong>[file_prefix]_obs_data.json</strong>, respectively.</p>
<h2 id="creating-params_for_id-file">Creating params_for_id file</h2>
<p>This file defines which parameters (constants and initial_states) within your model that you will vary in the parameter id process and their allowed ranges (prior distribution). Following is an example of the <code>params_for_id.csv</code> file.</p>
<p><img alt="params_for_id.csv" src="../images/params-for-id.png" /></p>
<p>The entries in the file are detailed as follows:</p>
<ul>
<li><strong>vessel_name</strong>: the name of the vessel/module the parameter is in</li>
<li><strong>param_name</strong>: the name of the parameter in the cellml module (not including the "vessel_name" suffix that is included in the <code>[file_prefix]_parameters.csv</code> file).</li>
<li><strong>param_type</strong>: <strong>"state"</strong> or <strong>"const"</strong>; whether the parameter is the initial value of a state or a const. </li>
<li><strong>min</strong>: The minimimum of the range of possible values (min of the uniform distribution).</li>
<li><strong>max</strong>: The maximum of the range of possible values (max of the uniform distribution).</li>
<li><strong>name_for_plotting</strong>: The name (latex format) that will be used when automatically potting comparisons with observables and predictions.</li>
</ul>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p><strong>param_type</strong> will be deprecated. All should be <strong>"const"</strong>. Initial values that need to identified should be defined as constants within the cellml module.</p>
</div>
<div class="admonition info">
<p class="admonition-title">Info</p>
<p>In the future we plan on including other types of priors rather than just uniform.</p>
</div>
<h2 id="creating-param-id-observables-file">Creating param id observables file</h2>
<p>This file defines the simulation protocol (protocol_info), and ground truth observables that will be used in the cost function for the parameter id optimisation algorithm. It also defines the measurement standard deviation, and weighting for each observable.</p>
<p>File path of the obs_data.json file should be defined as <strong>param_id_obs_path</strong> in <code>[CA_dir]/user_run_files/user_inputs.yaml</code>.</p>
<h1 id="protocol-info">protocol info</h1>
<p>The protocol info defines the numerical experiments you will be running. Here is an example for a sympathetic neuron calibration where the input current is changed
from 0 to 0.15 pA after 1 second then simulated for 2 seconds with that input current. This was performed in two experiments, the first experiment with a M-type potassium conductance of 0.08 uS and the second experiment with an increased M-type potassium channel conductance of 0.12 uS.</p>
<p><img alt="obs_data.json for constant" src="../images/protocol-info.png" /></p>
<p>For the protocol we define each experiment as each new full simulation that needs to be run. Each subexperiment is a section of an experiment 
with its own set of parameters. Subexperiments generally relate to different time periods where the inputs in the experiments that are being used for 
calibration have a change in value (e.g. change in drug concentration, change in stimulatiion frequency, change in applied force). The entries in the protocol info are:</p>
<ul>
<li><strong>pre_times</strong>: The amount of simulation that is done before you want to compare to observables or plot (this part of the simulation is thrown away. This
is mainly used to simulate for an amout of time to reach steady state or periodic state. shape = (number of experiments)</li>
<li><strong>sim_times</strong>: The length in time of each subexperiment. shape=(number of experiments, number of subexperiments) -- Note: the shape isn't completely correct here, the number of subexperiments can be different for each experiment</li>
<li><strong>params_to_change</strong>: A dictionary where the key is a parameter name and the entry is the assigned value of that parameter in each (experiment_idx, subexperiment_idx).</li>
<li><strong>experiment_colors</strong>: The line color for the plots of each experiment. </li>
<li><strong>experiment_labels</strong>: The label for each experiment, which is used for plotting and naming plots.</li>
</ul>
<h1 id="data-items">data items.</h1>
<p>Examples of <code>obs_data.json</code>, <code>data_item</code> entries are shown in below figures for constant, constant with operation_kwargs, series, and frequency data types, respectively. </p>
<p><img alt="obs_data.json for constant" src="../images/obs-data-constant.png" />
<img alt="obs_data.json for constant 2" src="../images/obs-data-constant2.png" />
<img alt="obs_data.json for  series" src="../images/obs-data-series.png" />
<img alt="obs_data.json for frequency" src="../images/obs-data-frequency.png" /></p>
<p>The entries in the data_item list in the <code>obs_data.json</code> file are:</p>
<ul>
<li><strong>variable</strong>: This is the user defined observable name, it does not need to link to the cellml variable name.</li>
<li><strong>data_type</strong>: The format of the data. This can be <em>"constant"</em>, <em>"series"</em>, or <em>"frequency"</em> as shown above.</li>
<li><strong>unit</strong>: The unit of the observable.</li>
<li><strong>name_for_plotting</strong>: The name that will be in the automated plots comparing observable data to model output. (latex format)</li>
<li><strong>weight</strong>: The weighting to put on this observables entry in the cost function. Default should be 1.0</li>
<li><strong>std</strong>: The standard deviation which is used in the cost function. The cost function is the relative absolute error (AE) or mean squared error (MRE), each normalised by the std.</li>
<li><strong>value</strong>: The value of the ground truth, either a scalar for constant data_type, or a list of values for series or frequency data_types.</li>
<li><strong>sample_rate</strong>: not needed or set to "null" for constant and frequency data_types. It defines the sample rate of the observable series values.</li>
<li><strong>operation</strong>: This defines the operation that will be done on the operands/variable. The possible operations to be done on model outputs are defined in <code>[CA_dir]/src/param_id/operation_funcs.py</code> and in <code>[CA_dir]/operation_funcs_user/operation_funcs_user.py</code> for user defined operations.</li>
<li><strong>operation_kwargs</strong>: This is a dictionary of key word arguments (kwargs) and their values that links to the kwargs in the chosen python operation function.</li>
<li><strong>operands</strong>: The above defined "operation" can take in multiple variables. If operands is defined, then the "variable" entry will be a placeholder name for the calculated variable and the operands will define the model variables that are used to calculate the final feature that will be compared to the observable value entry/s.</li>
</ul>
<div class="admonition warning">
<p class="admonition-title">Warning</p>
<p><strong>obs_type</strong>: This has been deprecated in favor of the <strong>operation</strong> entry.</p>
</div>
<h2 id="creating-your-own-operations">Creating your own operations</h2>
<p>To enable flexibility we allow you to create your own user-defined operation functions in python to extract features from your model outputs and compare to data in the calibration.
Available operation functions can be found in <code>src/param_id/operation_funcs.py</code> and in the file made for adding your own operation functions in <code>funcs_user/operation_funcs_user.py</code>.
Here is an example of an operation function for calculating the ratio of the two peaks (used for mitral valve flow).</p>
<p><img alt="Operation func example" src="../images/E-A-ratio.png" /></p>
<p>Note:</p>
<ul>
<li>kwargs can be used and defined for each entry in your obs_data.json with <code>operation_kwargs</code>, see above.</li>
<li><code>if series_output</code> is needed to return the variable trace for plotting.</li>
<li>A more elegant method of returning a high cost if the observable can't be calculated is being discussed.</li>
</ul>
<h2 id="creating-your-own-cost-functions">Creating your own cost functions</h2>
<p>To allow even more flexibility, we also allow users to define their own cost functions (or likelihood functions). These can be found at <code>funcs_user/cost_funcs_user.py</code>.
An example for the maximum likelihood estimator for gaussian noise (equivalent to weighted mean squared error) is:</p>
<p><img alt="cost func example" src="../images/cost-func.png" /></p>
<p>Note:</p>
<ul>
<li>Currently there are no kwargs for user defined cost functions. But there will be: see <a href="https://github.com/FinbarArgus/circulatory_autogen/issues/84">issue</a></li>
</ul>
<h2 id="parameter-identification-settings">Parameter Identification Settings</h2>
<p>To run the parameter identification we need to set a few entries in the <code>[CA_dir]/user_run_files/user_inputs.yaml file</code>:</p>
<ul>
<li><strong>param_id_method</strong>: this defines the optimisation method we use. Currently this can only be genetic_algorithm, but more methods are being implemented. Eventually we aim to use CVODES to allow for gradient based optimisation methods.</li>
<li><strong>pre_time</strong>: this is the amount of time the simulation is run to get to steady state before comparing to the observables from <code>obs_data.json</code>. IMPORTANT: THis is overwritten by the pre_times within the obs_data.json file, see the next section.</li>
<li><strong>sim_time</strong>: The amount of time used to compare simulation output and observable data. This should be equal to the length of a series observable entry divided by the "sample_rate". If not, only up to the minimum length of observable data and modelled data will be compared. </li>
<li><strong>maximum_step</strong>: The maximum time step for the CVODE solver</li>
<li><strong>dt</strong>: The output time step (This hasn't been tested well for anything but 0.01 s currently)</li>
<li><strong>param_id_obs_path</strong>: the path to the <code>obs_data.json</code> file described above.</li>
<li><strong>ga_options</strong>:<ul>
<li><strong>cost_type</strong>: "AE" or "MSE" for absolute error or mean squared error.</li>
<li><strong>num_calls_to_function</strong>: How many forward simulations of pre_time+sim_time will be run in the optimisation algorithm.</li>
</ul>
</li>
<li>Note: In the future entries to ga_options will be kwargs that are used in the underlying user defined optimisation schemes (see <a href="https://github.com/FinbarArgus/circulatory_autogen/issues/79">link</a>)</li>
</ul>
<h2 id="running-parameter-identification">Running parameter identification</h2>
<p>After creating the params_for_id file and the param id observables file, and configuring the above settings, run the parameter identification using the below command.</p>
<div class="highlight"><pre><span></span><code>./run_param_id.sh
</code></pre></div>
<p>Following a successful parameter id process, the model with updated parameters can be generated with:</p>
<div class="highlight"><pre><span></span><code>./run_autogeneration_with_id_params.sh
</code></pre></div>
<div class="admonition note">
<p class="admonition-title">Note</p>
<p>IMPORTANT: After running the calibration, you should plot the simulation outputs vs the ground truth to analyse the fits!! This can be done with:</p>
<div class="highlight"><pre><span></span><code>  ./plot_param_id.sh
</code></pre></div>
<p>The generated models will be saved in <code>generated_models/</code> directory and plots will be saved in <code>param_id_outputs/</code> directory.</p>
</div>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    
      
      <script id="__config" type="application/json">{"base": "..", "features": ["instant", "content.code.copy"], "search": "../assets/javascripts/workers/search.d50fe291.min.js", "tags": null, "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}, "version": null}</script>
    
    
      <script src="../assets/javascripts/bundle.13a4f30d.min.js"></script>
      
    
  </body>
</html>